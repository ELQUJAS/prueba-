<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <title>Mapa de Iniciativas</title> <style>
            html, body, #map {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }
            /* Estilos existentes para la alineación del símbolo en el control de capas (si aún se usa para otras capas) */
            .leaflet-control-layers-overlays img {
                vertical-align: middle;
                margin-right: 2px;
                width: 16px;
                height: 16px;
            }

            /* --- ESTILOS PARA LA LEYENDA PERSONALIZADA --- */
            .info.legend {
                background: white;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                line-height: 1.5; /* Espaciado entre líneas */
                font-family: sans-serif; /* Fuente legible */
                font-size: 14px; /* Tamaño de fuente para la leyenda */
            }
            .legend-title {
                font-weight: bold;
                margin-bottom: 8px; /* Aumentado para mejor separación */
                text-align: center;
                font-size: 16px; /* Tamaño de fuente para el título */
                color: #333; /* Color de texto más oscuro */
            }
            .legend-item {
                display: flex; /* Para alinear el símbolo y el texto */
                align-items: center; /* Alineación vertical al centro */
                margin-bottom: 5px; /* Aumentado para mejor separación entre items */
            }
            .legend-symbol {
                width: 14px; /* Tamaño del símbolo de círculo en la leyenda */
                height: 14px;
                border-radius: 50%; /* Para que sea un círculo */
                border: 1px solid rgba(35,35,35,0.8); /* Borde similar al de los puntos */
                margin-right: 10px; /* Espacio entre el símbolo y el texto */
                flex-shrink: 0; /* Evita que el símbolo se encoja */
            }
            /* --- FIN DE ESTILOS DE LEYENDA --- */
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/union_2.js"></script>
        <script>
            let highlightLayer;

            function highlightFeature(e) {
                if (highlightLayer && highlightLayer.defaultOptions && highlightLayer.defaultOptions.style) {
                    highlightLayer.setStyle(highlightLayer.defaultOptions.style);
                }

                highlightLayer = e.target;
                highlightLayer.defaultOptions = highlightLayer.defaultOptions || {};
                highlightLayer.defaultOptions.style = JSON.parse(JSON.stringify(highlightLayer.options));

                if (e.target.feature.geometry.type === 'LineString') {
                    highlightLayer.setStyle({
                        color: '#ffff00',
                        weight: 4
                    });
                } else {
                    highlightLayer.setStyle({
                        fillColor: '#ffff00',
                        fillOpacity: 1,
                        radius: 10
                    });
                }

                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    highlightLayer.bringToFront();
                }
            }

            function resetHighlight(e) {
                if (e.target.defaultOptions && e.target.defaultOptions.style) {
                    e.target.setStyle(e.target.defaultOptions.style);
                } else {
                    e.target.setStyle(style_union_2_0(e.target.feature));
                }
                highlightLayer = null;
            }

            var map = L.map('map', {
                zoomControl:true, maxZoom:28, minZoom:1
            });

            var hash = new L.Hash(map);
            map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
            var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

            function removeEmptyRowsFromPopupContent(content, feature) {
               var tempDiv = document.createElement('div');
               tempDiv.innerHTML = content;
               var rows = tempDiv.querySelectorAll('tr');
               for (var i = 0; i < rows.length; i++) {
                   var td = rows[i].querySelector('td.visible-with-data');
                   var key = td ? td.id : '';
                   if (td && td.classList.contains('visible-with-data') && (feature.properties[key] == null || feature.properties[key] === '')) {
                       rows[i].parentNode.removeChild(rows[i]);
                   }
               }
               return tempDiv.innerHTML;
            }

            document.querySelector(".leaflet-popup-pane").addEventListener("load", function(event) {
              var tagName = event.target.tagName,
                popup = map._popup;
              if (tagName === "IMG" && popup && !popup._updated) {
                popup._updated = true;
                popup.update();
              }
            }, true);

            var bounds_group = new L.featureGroup([]);
            
            function setBounds() {
                if (bounds_group.getLayers().length > 0) {
                    map.fitBounds(bounds_group.getBounds());
                }
            }

            map.createPane('pane_EsriSatellite_0');
            map.getPane('pane_EsriSatellite_0').style.zIndex = 400;
            var layer_EsriSatellite_0 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                pane: 'pane_EsriSatellite_0',
                opacity: 1.0,
                attribution: 'Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community',
                minZoom: 1,
                maxZoom: 28,
                minNativeZoom: 0,
                maxNativeZoom: 17
            });
            map.addLayer(layer_EsriSatellite_0);

            map.createPane('pane_OpenStreetMap_1');
            map.getPane('pane_OpenStreetMap_1').style.zIndex = 401;
            var layer_OpenStreetMap_1 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                pane: 'pane_OpenStreetMap_1',
                opacity: 1.0,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                minZoom: 1,
                maxZoom: 28,
                minNativeZoom: 0,
                maxNativeZoom: 19
            });

            function pop_union_2(feature, layer) {
                layer.on({
                    mouseout: resetHighlight,
                    mouseover: highlightFeature,
                });
                var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Categoría:</th>\
                        <td class="visible-with-data" id="Name">' + (feature.properties ['Name'] !== null ? autolinker.link(feature.properties ['Name'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Descripción:</th>\
                        <td class="visible-with-data" id="descriptio">' + (feature.properties ['descriptio'] !== null ? autolinker.link(feature.properties ['descriptio'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Academicos:</th>\
                        <td class="visible-with-data" id="Academicos">' + (feature.properties ['Academicos'] !== null ? autolinker.link(feature.properties ['Academicos'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
                layer.bindPopup(popupContent, {maxHeight: 400});
                var popup = layer.getPopup();
                var content = popup.getContent();
                var updatedContent = removeEmptyRowsFromPopupContent(content, feature);
                popup.setContent(updatedContent);
            }

            function getColor(nombre) {
                const nameLower = String(nombre).toLowerCase();

                if (nameLower.includes('monitoreo o muestreo de la especie')) {
                    return 'deepskyblue'; // Celeste
                } else if (nameLower.includes('iniciativas de educación y difusión')) {
                    return 'yellow'; // Amarillo
                } else if (nameLower.includes('relevamiento de informacion sobre relacion guigna-humanos')) {
                    return 'lime'; // Verde
                } else if (nameLower.includes('reducción o mitigación de amenazas')) {
                    return 'red'; // Rojo
                }
                // Eliminada la condición 'else' para "Otras", si el nombre no coincide, no tendrá un color específico aquí.
                // Si quieres que los puntos sin categoría explícita no aparezcan o tengan otro color, ajusta según necesidad.
                return '#808080'; // Color por defecto si no coincide con ninguna de las categorías listadas.
            }

            function style_union_2_0(feature) {
                return {
                    pane: 'pane_union_2',
                    radius: 8.0,
                    opacity: 1,
                    color: 'rgba(35,35,35,1.0)',
                    dashArray: '',
                    lineCap: 'butt',
                    lineJoin: 'miter',
                    weight: 1,
                    fill: true,
                    fillOpacity: 1,
                    fillColor: getColor(feature.properties['Name']),
                    interactive: true,
                }
            }

            map.createPane('pane_union_2');
            map.getPane('pane_union_2').style.zIndex = 402;
            map.getPane('pane_union_2').style['mix-blend-mode'] = 'normal';
            var layer_union_2 = new L.geoJson(json_union_2, {
                attribution: 'Datos de Iniciativas',
                interactive: true,
                dataVar: 'json_union_2',
                layerName: 'layer_union_2',
                pane: 'pane_union_2',
                onEachFeature: pop_union_2,
                pointToLayer: function (feature, latlng) {
                    var context = {
                        feature: feature,
                        variables: {}
                    };
                    return L.circleMarker(latlng, style_union_2_0(feature));
                },
            });
            bounds_group.addLayer(layer_union_2);
            map.addLayer(layer_union_2);

            var baseMaps = {
                "Esri Satellite": layer_EsriSatellite_0,
                "OpenStreetMap": layer_OpenStreetMap_1
            };

            var overlayMaps = {
                "Iniciativas": layer_union_2
            };

            L.control.layers(baseMaps, overlayMaps, {
                collapsed: false
            }).addTo(map);

            map.on('overlayadd', function(eventLayer) {
                if (eventLayer.layer === layer_union_2) {
                    setBounds();
                }
            });
            setBounds();

            map.addControl(new L.Control.Search({
                layer: layer_union_2,
                initial: false,
                hideMarkerOnCollapse: true,
                propertyName: 'Name',
                zoom: 16
            }));

            document.getElementsByClassName('search-button')[0].className +=
                ' fa fa-binoculars';

            // --- CÓDIGO PARA LA LEYENDA PERSONALIZADA ---
            var legend = L.control({position: 'bottomright'});

            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');
                div.innerHTML += '<div class="legend-title">Categorías</div>';

                var categories = [
                    { name: 'Monitoreo o muestreo de la especie', color: 'deepskyblue' },
                    { name: 'Iniciativas de Educación y difusión', color: 'yellow' },
                    { name: 'Relevamiento de información sobre relación güiña-humanos', color: 'lime' },
                    { name: 'Reducción o mitigación de amenazas', color: 'red' }
                    // La categoría "Otras" ha sido eliminada de aquí.
                ];

                for (var i = 0; i < categories.length; i++) {
                    div.innerHTML +=
                        '<div class="legend-item">' +
                            '<span class="legend-symbol" style="background:' + categories[i].color + '"></span>' +
                            '<span>' + categories[i].name + '</span>' +
                        '</div>';
                }
                return div;
            };
            legend.addTo(map);
            // --- FIN DEL CÓDIGO DE LEYENDA ---
        </script>
    </body>
</html>
